<!DOCTYPE html>

<html>
<!--
-->
	<head>
		<meta charset="UTF-8">
		<link rel="stylesheet" href="/styles.css">
		<title>MyTager</title>
	</head>
	<body class="nospace">
		<div class="container">
			<div id="divHelp" class="nospace hiddenHelp">
				<table>
					<tr><td colsapn=2><b>Keys:</b></td></tr>
					<tr><td>&nbsp;* ArrowLeft  </td><td>- prev picture</td></tr>
					<tr><td>&nbsp;* ArrowRight </td><td>- next picture</td></tr>
					<tr><td>&nbsp;* ArrowUp    </td><td>- directory up</td></tr>
					<tr><td>&nbsp;* Esc        </td><td>- unfocus</td></tr>
						<tr><td colsapn=2><b>Mouse:</b></td></tr>
					<tr><td>&nbsp;* WheelUp   </td><td>- prev picture </td></tr>
					<tr><td>&nbsp;* WheelDown </td><td>- next picture </td></tr>
					<tr><td>&nbsp;* Click     </td><td>- zoom in / out</td></tr>
				</table>
			</div>
			<div id="divAttention" class="attention floating legend">
				<div id="divAttentionMove" class="mover"></div>
				    <button id="linkHelp"     class="btnWidthFull">help</button>
				<br><button id="linkHome"     class="btnWidthHalf">home</button><button id="linkReload"   class="btnWidthHalf">reload</button>
				<br><button id="linkShutdown" class="btnWidthFull">shutdown server</button>
				<br><button id="linkDel"      class="btnWidthFull careful">DELETE PICTURE</button>
			</div>
			<div id="divTitle" class="title floating legend">
				<div id="divTitleMove" class="mover"></div>
				{ImagePath}/ <b>{SourceFile}</b> ({DateTimeOriginal})
			</div>
			<div id="divTags" class="tags floating legend">
				<div id="divTagsMove" class="mover"></div>
				<fieldset class="legendPadding">
					<legend class="medium-text">Rating</legend>
					<label for="0">0</label>
					<input type="radio" id="Rating0" name="Rating" class=" legendPadding" value="0">
					<input type="radio" id="Rating1" name="Rating" class=" legendPadding" value="1">
					<input type="radio" id="Rating2" name="Rating" class=" legendPadding" value="2">
					<input type="radio" id="Rating3" name="Rating" class=" legendPadding" value="3">
					<input type="radio" id="Rating4" name="Rating" class=" legendPadding" value="4">
					<input type="radio" id="Rating5" name="Rating" class=" legendPadding" value="5">
					<label for="5">5</label>
				</fieldset>
				<fieldset class="legendPadding">
					<legend class="medium-text">ImageDescription</legend>
					<textarea id="ImageDescription" class="small-text" placeholder="ImageDescription" rows="3" 
>{ImageDescription}</textarea>
				</fieldset>
				<fieldset class="legendPadding">
					<legend class="medium-text">UserComment</legend>
					<textarea id="UserComment" class="small-text" placeholder="UserComment" rows="3"
>{UserComment}</textarea>
					<div id="tags" class="legendPadding small-text"></div>
				</fieldset>
				<textarea id="StaticText" class="small-text" placeholder="StaticText" rows="1"
>{StaticText}</textarea><br>
				 <button id="linkPrev">&larr;</button
				><button id="linkUp"  >&uarr;</button
				><button id="linkNext">&rarr;</button
				><button id="saveNext">save & next</button>
			</div>
			<div id="imageContainer" class="imageContainer">
					<img id="image" class="img-resize" src="/images/{ImagePath}/{SourceFile}">
			</div>
		</div>
		<script type="text/javascript" nonce="{script-nonce}">
			var data = {
				  "SourceFile"      : "{ImagePath}/{SourceFile}"
				, "ImageDescription": "{ImageDescription}"
				, "UserComment"     : `{UserComment}`
				, "Rating"          : "{Rating}"
			}
			if(window.location.hash)
				document.getElementById("StaticText").value = window.location.hash.substring(1);

			setTags(data);

			var myTags = 
			{TagJsonData}
			;

			var div =  document.getElementById("tags");
			for (var i in myTags){
				div.innerHTML += ""+ i +": ";
				var l = 0;
				for (var tagName in myTags[i]){
					var tag = myTags[i][tagName];
					div.innerHTML += (l==0 ? '':', ');
					div.innerHTML +=  '<a id="tag'+tag+'" class="small-text"  href="javascript:addTag(\''+tag+'\')">'+ tagName +'</a>';
					l++;
				}
				div.innerHTML += "<br>";
			}

			var saveBtn = document.getElementById("saveNext");
			saveBtn.addEventListener("click", function(){callPostExif(event)});

			function navigate(path){
				var staticText = document.getElementById("StaticText").value;
				if (path === "/")
					document.location = path +"#"+ staticText
				else
					document.location = path + data["SourceFile"]+"#"+ staticText
			}
			document.getElementById("linkPrev"     ).addEventListener("click", function(){ navigate("/nav/prev/"); });
			document.getElementById("linkNext"     ).addEventListener("click", function(){ navigate("/nav/next/"); });
			document.getElementById("linkUp"       ).addEventListener("click", function(){ navigate("/nav/up/"  ); });
			document.getElementById("linkDel"      ).addEventListener("click", function(){ navigate("/del/"     ); });
			document.getElementById("linkShutdown" ).addEventListener("click", function(){ document.location = "/shutdown"; });
			document.getElementById("linkHome"     ).addEventListener("click", function(){ document.location = "/html";     });
			document.getElementById("linkReload"   ).addEventListener("click", function(){ document.location.reload();      });
			document.getElementById("image"        ).addEventListener('wheel', zoom);

			var img = document.getElementById("image");
			function zoom(e){
				if (img.classList.contains("img-resize")) {
					if (e.deltaY > 0      ) navigate("/nav/next/");
					if (e.deltaY < 0 /*>*/) navigate("/nav/prev/"); // the comment workaround for syntaxhighlighting glitch in editor
				}
			}
		
			function switchImage(event){
				if (img.classList.contains("img-resize")) {
					var scrollX = event.pageX *100 / img.clientWidth;
					var scrollY = event.pageY *100 / img.clientHeight;
					img.classList.remove("img-resize");
					img.classList.add   ("img-normal");
					scrollX = img.clientWidth  /100 * scrollX - event.pageX;
					scrollY = img.clientHeight /100 * scrollY - event.pageY;
					document.getElementById("imageContainer").scrollTo(scrollX,scrollY);
				} else {
					img.classList.remove("img-normal");
					img.classList.add   ("img-resize");
				}
			}
			document.getElementById("image" ).addEventListener("click", switchImage);

			function handleKeyEvent(e){
				e = e || window.event;
				//console.log('### '+ e.key +":"+ document.activeElement.tagName);
				var sourceTag = document.activeElement.tagName;
				if (sourceTag=="BODY") {
					if (e.key == "ArrowLeft" ) return navigate("/nav/prev/");
					if (e.key == "PageUp"    ) return navigate("/nav/prev/");
					if (e.key == "ArrowRight") return navigate("/nav/next/");
					if (e.key == "PageDown"  ) return navigate("/nav/next/");
					if (e.key == "ArrowUp")    return navigate("/nav/up/");
					document.getElementById("UserComment").focus();
				}
				if (e.key == "Escape") {
						document.activeElement.blur();
				}	
			}
			window.addEventListener('keydown', function(){handleKeyEvent(event)});


			
			function repaintUserComment(){
				var key = window.event.keyCode;
				if (key === 13 || key===44) { 
					repaintTags(); 
					return false; 
				}
				return true; 
			}

			document.getElementById("UserComment").addEventListener("keypress",repaintUserComment );
			document.getElementById("UserComment").addEventListener("blur"    ,repaintTags );
			
			repaintTags();



			function callPostExif(){
				var headers = ({'Content-Type': 'application/json'});
				var body = getTags();
				// Komma vorne + hinten fuer bessere Suche
console.log("#### uc: "+ body["UserComment"]);
				if (body["UserComment"]) body["UserComment"] = "," + body["UserComment"] +","
console.log("#### uc: "+ body["UserComment"]);
				body = JSON.stringify(body);
				fetch("http://127.0.0.1:5000/html/"+ encodeURI(data["SourceFile"])
					, { method: "POST", headers: headers, body: body }
				).then(  (res)  => { 
					return res.text().then( txt => {
						document.location = "/html/"+txt+"#"+ document.getElementById("StaticText").value;
					});
				})
				.catch( (err)  => { console.log("POST: "+ err) });
			}


			function getTags(){
				var uc = document.getElementById("UserComment"     ).value;
				var id = document.getElementById("ImageDescription").value;
				var st = document.getElementById("StaticText"      ).value;
				var rating = document.querySelector('input[name="Rating"]:checked').value
				return {'UserComment': uc,'ImageDescription': id, 'Rating': rating, 'StaticText': st};
			}

			
			function setTags(json){
				document.getElementById("ImageDescription").value = json["ImageDescription"];
				var rating = json["Rating"] || "0";
				document.getElementById("Rating"+rating).checked=true;
				
				var static = document.getElementById("StaticText").value
				var uc = json["UserComment"];
				if (static) {
					//console.log("STATIC "+static);
					if (uc) 
						uc = static +","+ uc;
					else 
						uc = static;
				}
				document.getElementById("UserComment"     ).value = uc;
				var list = getUserTags();
				document.getElementById("UserComment").value = list.sort(compareTrimed).join();
			}


			function getUserTags(){
				var uc = document.getElementById("UserComment").value;
				uc = uc.replace(", ",",")
				if (uc.charAt(0)==",") uc = uc.substring(1);
				uc = uc.split(",");
				return uc;
			}
			function setUserTags(tagList){
				var uc = document.getElementById("UserComment").value = tagList.join();
			}



			function addTag(tag){
				var list = getUserTags();
				const equalsIgnoreCase = (element) => element.toLowerCase().trim() === tag.toLowerCase();
				var idx = list.findIndex(equalsIgnoreCase);
				if (idx>=0) {
					list.splice(idx,1);
				} else {
					list.push(tag);
				}
				document.getElementById("UserComment").value = list.sort(compareTrimed).join();
				repaintTags();
			}


			function repaintTags(){
				var list = getUserTags();
				list = Array.from(new Set(list))
				setUserTags(list);
			
				for (var i in myTags){
					for (var j in myTags[i]){
						var tag = myTags[i][j];
						var elem = document.getElementById("tag"+tag);
						const equalsIgnoreCase = (element) => element.toLowerCase().trim() === tag.toLowerCase();
						var idx = list.findIndex(equalsIgnoreCase);
						if (idx>=0) {
							elem.classList.add("activeTag");
						} else {
							elem.classList.remove("activeTag");
						}
					}
				}
			}
			
			function compareTrimed(_a, _b) {
				var a = _a.trim();
				var b = _b.trim();
				var a1 = _a.charAt(1);
				var b1 = _b.charAt(1);
				if (a1==":" && b1!=":") return  1;
				if (a1!=":" && b1==":") return -1;
				if (a > b) return 1;
				if (b > a) return -1;
				return 0;
			}

			
			linkHelp.addEventListener('mousedown', function (e) {
				helpDiv = document.getElementById('divHelp');
				helpDiv.style.visibility='visible';
			});
			linkHelp.addEventListener('mouseup', function (e) {
				helpDiv = document.getElementById('divHelp');
				helpDiv.style.visibility='hidden';
				document.activeElement.blur();
			});
			
			
			// make Divs moveable
			var mousedown = false;

			var divAttention     = document.getElementById('divAttention');
			var divAttentionMove = document.getElementById('divAttentionMove');
			divAttentionMove.addEventListener('mousedown', function (e) {
				mousedown = true;
				moveDiv = divAttention;
				x = divAttention.offsetLeft - e.clientX; 
				y = divAttention.offsetTop  - e.clientY; 
			});
			divAttention.addEventListener('mouseup', function (e) { mousedown = false; }, true); 

			var divTitle = document.getElementById('divTitle');
			var divTitleMove = document.getElementById('divTitleMove');
			divTitleMove.addEventListener('mousedown', function (e) {
				mousedown = true;
				moveDiv = divTitle;
				x = divTitle.offsetLeft - e.clientX; 
				y = divTitle.offsetTop  - e.clientY; 
			});
			divTitle.addEventListener('mouseup', function (e) { mousedown = false; }, true); 

			var divTags = document.getElementById('divTags');
			var divTagsMove = document.getElementById('divTagsMove');
			divTagsMove.addEventListener('mousedown', function (e) {
				 mousedown = true;
				 moveDiv = divTags;
				 x = divTags.offsetLeft - e.clientX; 
				 y = divTags.offsetTop  - e.clientY; 
			});
			divTags.addEventListener('mouseup', function (e) { mousedown = false; }, true); 

			var divContainer = document.querySelector('.container');
			divContainer.addEventListener('mousemove', function (e) { 
				 if (mousedown) { 
					 moveDiv.style.left = e.clientX + x + 'px'; 
					 moveDiv.style.top  = e.clientY + y + 'px';
				 } 
			 }, true); 

			// fix heigth
			//divTitle    .setAttribute("style","height:"+ (divTitle     .offsetHeight -10) +"px");
			//divTags     .setAttribute("style","height:"+ (divTags      .offsetHeight -10) +"px");
			//divAttention.setAttribute("style","height:"+ (divAttention .offsetHeight -10) +"px");
			
		</script>
	</body>
</html>